{
  "description":"steps in the alignment pipeline to post-process bam files produced by the AlignmentFilter in Bam to Cram graph",
  "version":"0.5",
  "subgraph_io":{
      "ports":{
          "inputs":{ "_stdin_":"bmd_multiway" },
          "outputs":{ 
              "_stdout_":"cram_file" 
          }
      }
  },
  "subst_params": [
    {"id":"cram_ext","required":"no","default":".cram"},
    {
      "id":"cram",
      "required":"yes",
      "subst_constructor":{
          "vals":[
              {"subst":"outdatadir"},
              "/",
              {"subst":"rpt"},
              {"subst":"cram_ext"}
          ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {"id":"cram_idx_ext","required":"no","default":".cram.crai"},
    {
      "id":"crai_file",
      "subst_constructor":{
        "vals":[ {"subst":"outdatadir"}, "/", {"subst":"fopid"}, {"subst":"cram_idx_ext"} ],
        "postproc":{"op":"concat", "pad":""}
      }
    },
    {
      "id":"cram_md5",
      "subst_constructor":{
          "vals":[ {"subst":"outdatadir"}, "/", {"subst":"fopid"}, ".cram.md5" ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {"id":"scramble_executable","required":"no","default":"scramble"},
    {
      "id":"scramble_reference_flag",
      "required":"no",
      "comment":"flag will disappear unless scramble_reference_fasta value is given (allows unaligned cram)",
      "subst_constructor":{ "vals":[ "-r", {"subst":"scramble_reference_fasta"} ]
      }
    },
    {
      "id":"scramble_cmd",
      "required":"yes",
      "subst_constructor":{
        "vals":[{"subst":"scramble_executable"}, "-I", "bam", "-O", "cram", {"subst":"scramble_reference_flag"}],
        "postproc":{"op":"pack"}
      }
    },
    {
      "id":"bamcheck_file",
      "required":"yes",
      "subst_constructor":{
          "vals":[ {"subst":"outdatadir"}, "/", {"subst":"fopid"}, ".bamcheck" ], 
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {"id":"stats_filter__F0x900","required":"no","default":"0x900"},
    {
      "id":"samtools_stats_F0x900",
      "required":"yes",
      "subst_constructor":{
          "vals":[ {"subst":"samtools_executable"}, "stats", "-F", {"subst":"stats_filter__F0x900"}, "-" ],
          "postproc":{"op":"pack","pad":" "}
      }
    },
    {
      "id":"stats_F0x900_file",
      "subst_constructor":{
          "vals":[ {"subst":"outdatadir"}, "/", {"subst":"fopid"}, "_F0x900.stats" ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {"id":"stats_filter__F0xB00","required":"no","default":"0xB00"},
    {
      "id":"samtools_stats_F0xB00",
      "required":"yes",
      "subst_constructor":{
          "vals":[ {"subst":"samtools_executable"}, "stats", "-F", {"subst":"stats_filter__F0xB00"}, "-" ],
          "postproc":{"op":"pack","pad":" "}
      }
    },
    {
      "id":"stats_F0xB00_file",
      "subst_constructor":{
          "vals":[ {"subst":"outdatadir"}, "/", {"subst":"fopid"}, "_F0xB00.stats" ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {"id":"flagstats_filter_flag","required":"no","default":"0x900"},
    {
      "id":"samtools_flagstat_filter",
      "required":"yes",
      "subst_constructor":{
          "vals":[ {"subst":"samtools_executable"}, "view", "-u", "-F", {"subst":"flagstats_filter_flag"}, "-" ],
          "postproc":{"op":"pack","pad":" "}
      }
    },
    {
      "id":"samtools_flagstat_cmd",
      "required":"yes",
      "subst_constructor":{
          "vals":[ {"subst":"samtools_executable"}, "flagstat", "-" ],
          "postproc":{"op":"pack","pad":" "}
      }
    },
    {
      "id":"flagstat_file",
      "required":"yes",
      "subst_constructor":{
          "vals":[ {"subst":"outdatadir"}, "/", {"subst":"fopid"}, ".flagstat" ],
          "postproc":{"op":"concat", "pad":""}
      }
    }
  ],
  "nodes": [
    {
      "id":"bmd_multiway",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": false,
      "cmd": ["teepot", "-vv", "-w", "300", "__SCRAMBLE_OUT__", "__BAMCHECK_OUT__", "__FLAGSTAT_OUT__", "__SAMTOOLS_STATS_F0x900_OUT__", "__SAMTOOLS_STATS_F0xB00_OUT__" ]
    },
    { "id":"cram_md5", "type":"OUTFILE", "name":{"subst":"cram_md5"} },
    {
      "id":"bamcheck",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":["bamcheck", "-F", "0x900"]
    },
    { "id":"bamcheck_file", "type":"OUTFILE", "name":{"subst":"bamcheck_file"} },
    {
      "id":"samtools_stats_F0x900",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":{"subst":"samtools_stats_F0x900"}
    },
    { "id":"stats_F0x900_file", "type":"OUTFILE", "name":{"subst":"stats_F0x900_file"} },
    {
      "id":"samtools_stats_F0xB00",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":{"subst":"samtools_stats_F0xB00"}
    },
    { "id":"stats_F0xB00_file", "type":"OUTFILE", "name":{"subst":"stats_F0xB00_file"} },
    {
      "id":"samtools_flagstat_filter",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":{"subst":"samtools_flagstat_filter"},
      "description":"Filter out secondary and supplementary alignment records"
    },
    {
      "id":"samtools_flagstat_cmd",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":{"subst":"samtools_flagstat_cmd"}
    },
    { "id":"flagstat_file", "type":"OUTFILE", "name":{"subst":"flagstat_file"} },
    {
      "id":"scramble",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":{"subst":"scramble_cmd"},
      "comment":"the environment variable REF_PATH must be set for bam2cram conversion to work without a reference"
    },
    {
      "id":"scramble_tee",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": false,
      "cmd": ["teepot", "-vv", "-w", "30000", "__CRAM_OUT__", "__MD5_OUT__", "__CRAI_OUT__"],
      "comment":"allow a generous 500 minutes for the teepot timeout"
    },
    {
      "id":"scramble_md5",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":"md5sum"
    },
    {
      "id":"cram_index",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":["cram_index", "-", {"subst":"crai_file"}]
    },
    {
      "id": "cram_file",
      "type": "OUTFILE",
      "name": {"subst":"cram"}
    },
    {
      "id":"postprocess_md5",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":["tr", "-d", " \\-\n"],
      "comment":"the double-backslash is required to get the correct character set to the tr command"
    }
  ],
	"edges": [
	  { "id":"bmdmw_to_scramble", "from":"bmd_multiway:__SCRAMBLE_OUT__", "to":"scramble" },
	  { "id":"scramble_to_scramble_tee", "from":"scramble", "to":"scramble_tee" },
	  { "id":"scramble_tee_to_md5", "from":"scramble_tee:__MD5_OUT__", "to":"scramble_md5" },
	  { "id":"md5_to_postprocess", "from":"scramble_md5", "to":"postprocess_md5" },
	  { "id":"corrected_md5_out", "from":"postprocess_md5", "to":"cram_md5" },
	  { "id":"scramble_tee_to_cramindex", "from":"scramble_tee:__CRAI_OUT__", "to":"cram_index" },
    { "id":"scramble_tee_to_cram", "from": "scramble_tee:__CRAM_OUT__", "to": "cram_file" },
	  { "id":"bmd_to_bamcheck", "from":"bmd_multiway:__BAMCHECK_OUT__", "to":"bamcheck" },
	  { "id":"bamcheck_to_file", "from":"bamcheck", "to":"bamcheck_file" },
	  { "id":"bmd_to_sts_F0x900", "from":"bmd_multiway:__SAMTOOLS_STATS_F0x900_OUT__", "to":"samtools_stats_F0x900" },
	  { "id":"samtools_stats_F0x900_to_file", "from":"samtools_stats_F0x900", "to":"stats_F0x900_file" },
	  { "id":"bmd_to_sts_F0xB00", "from":"bmd_multiway:__SAMTOOLS_STATS_F0xB00_OUT__", "to":"samtools_stats_F0xB00" },
	  { "id":"samtools_stats_F0xB00_to_file", "from":"samtools_stats_F0xB00", "to":"stats_F0xB00_file" },
	  { "id":"bmd_to_flagstat", "from":"bmd_multiway:__FLAGSTAT_OUT__", "to":"samtools_flagstat_filter" },
	  { "id":"flagstat_filter_to_flagstat", "from":"samtools_flagstat_filter", "to":"samtools_flagstat_cmd" },
	  { "id":"flagstat_to_file", "from":"samtools_flagstat_cmd", "to":"flagstat_file" }
  ]
}
