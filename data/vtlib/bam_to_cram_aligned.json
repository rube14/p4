{
  "description": "Read ALIGNED data in BAM format producing output in CRAM format: full PG history, complete SQ lines, adapter marking, etc. Uses Biobambam2",
  "version":"0.8",
  "subst_params": [
    {"id":"target_indicator","default":""},
    {
      "id":"fopid_tgt",
      "comment":"id passed to the final_output_prep template; used there to construct unique file names",
      "subst_constructor":{
          "vals":[
              {"subst":"rpt"},
              {"subst":"target_indicator"}
          ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {"id":"bam_ext","required":"no","default":".bam"},
    {
      "id":"src_bam",
      "required":"yes",
      "subst_constructor":{
          "vals":[ {"subst":"indatadir"}, "/", {"subst":"rpt"}, {"subst":"bam_ext"} ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {"id":"samtools_executable","required":"no","default":"samtools"},
    {
      "id":"sam_headerRGfix",
      "required":"yes",
      "subst_constructor":{
          "vals":[
              {"subst":"samtools_executable"},
              "view",
              "-H",
              "-"
          ],
          "postproc":{"op":"pack","pad":" "}
      }
    },
    {
      "id":"alterRG_headerRGfix",
      "required":"yes",
      "subst_constructor":{
					"vals":[
							"perl",
							"/nfs/gapi/users/rb11/viv_reprocessing/bin/filter_header_r_v1.pl",
							"-rpt",
							{"subst": "rpt"}
					],
					"postproc":{"op":"pack","pad":" "}
				}
    },
    {
      "id":"reheader_headerRGfix",
      "required":"yes",
      "subst_constructor":{
          "vals":[
              {"subst":"samtools_executable"},
              "reheader",
              "__IN_SAMHEADER__",
              "-"
          ],
          "postproc":{"op":"pack","pad":" "}
      }
    },
    { "id":"phix_or_target", "required":"no", "default":""},
    {
      "id":"bs_tmpfile_flag",
      "required":"no",
      "subst_constructor":{
          "vals":[
              "tmpfile=",
              {"subst":"outdatadir"},
              "/",
              {"subst":"bstmp"},
              "_",
              {"subst":"rpt"},
              {"subst":"phix_or_target"},
              ".tmp"
          ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {
      "id":"bmd_tmpfile_flag",
      "required":"no",
      "subst_constructor":{
          "vals":[
              "tmpfile=",
              {"subst":"outdatadir"},
              "/",
              {"subst":"bmdtmp","required":"yes"},
              "_",
              {"subst":"rpt"},
              {"subst":"phix_or_target"},
              ".tmp"
          ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {
      "id":"bmd_metrics_file_flag",
      "required":"no",
      "subst_constructor":{
          "vals":[
              "M=",
              {"subst":"outdatadir"},
              "/",
              {"subst":"rpt"},
              {"subst":"phix_or_target"},
              ".markdups_metrics.txt"
          ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {
      "id":"bamsortcoord_markdup",
      "required":"yes",
      "subst_constructor":{
          "vals":[
              "bamsormadup",
              "SO=coordinate",
              "level=0",
              "threads=2",
              {"subst":"bmd_tmpfile_flag"},
              {"subst":"bmd_metrics_file_flag"}
          ],
          "postproc":{"op":"pack", "pad":" "}
      }
    },
    {"id":"bam_to_cram_output_prep_name","required":"no","default":"bam_to_cram_output_prep"},
    {
      "id":"bam_to_cram_output_prep",
      "required":"yes",
      "subst_constructor":{
          "vals":[
              {"subst":"cfgdatadir"},
              "/",
              {"subst":"bam_to_cram_output_prep_name"},
              ".json"
          ],
          "postproc":{"op":"concat", "pad":""}
      }
    },
    {"id":"seqchksum_vtf","required":"no","default":"bam_to_cram_seqchksum"},
    {
      "id":"bam_to_cram_seqchksum",
      "required":"yes",
      "subst_constructor":{
          "vals":[
              {"subst":"cfgdatadir"},
              "/",
              {"subst":"seqchksum_vtf"},
              ".json"
          ],
          "postproc":{"op":"concat", "pad":""}
      }
    }
  ],
  "nodes": [
    {
      "id": "src_bam",
      "type": "INFILE",
      "name": {"subst":"src_bam"},
      "description": "BAM used as input to this pipeline - expected to already contain PhiX (normally from hyb buffer spike-in) alignments"
    },
    {
      "id":"sam_headerRGfix",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":{"subst":"sam_headerRGfix"}
    },
    {
      "id":"alterRG_headerRGfix",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":{"subst":"alterRG_headerRGfix"},
      "description": "update RG line"
    },
    {
      "id":"reheader_headerRGfix",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":{"subst":"reheader_headerRGfix"}
    },
    {
      "id": "bamsormadup_qname",
      "type": "EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd": ["bamsormadup", "SO=queryname", "level=0", "threads=2"],
      "comment": "ensure BAM records are gathered by template i.e. queryname"
    },
    {
      "id":"bamsortcoord_markdup",
      "type":"EXEC",
      "use_STDIN": true,
      "use_STDOUT": true,
      "cmd":{"subst":"bamsortcoord_markdup"},
      "comment": "sort name collated BAM by coordinate and mark duplicates default tool bamsormadup must be from Biobambam2 >= 2.0.0"
    },
    {
      "id": "bam_to_cram_output_prep",
      "type": "VTFILE",
      "subst_map":
      {
        "phix_or_target":"",
        "fopid":{"subst":"fopid_tgt"},
        "bstmp":"bspaft",
        "brtmp":"brpaft",
        "bmdtmp":"bmdpaft"
      },
      "name": {"subst":"bam_to_cram_output_prep"},
      "comment":"inputs: _stdin_ (bam); outputs: _stdout_ (cram)",
      "description": "subgraph containing post alignment_filter process (target)"
    },

    {
      "id":"bam_to_cram_seqchksum",
      "type":"VTFILE",
      "comment":"inputs: _stdin_ (start bam), target_bam",
      "name":{"subst":"bam_to_cram_seqchksum"},
      "description":"subgraph containing seqchksum validation of outputs"
	}

  ],
  "edges": [
    { "id":"src_to_sam_headerRGfix", "from": "src_bam", "to": "sam_headerRGfix" },
    { "id":"src_to_sam_headerRGfix", "from": "src_bam", "to": "reheader_headerRGfix" },
    { "id":"sam_headerRGfix_to_alterRG", "from":"sam_headerRGfix", "to":"alterRG_headerRGfix" },
    { "id":"alterRG_headerRGfix_to_reheader", "from":"alterRG_headerRGfix", "to":"reheader_headerRGfix:__IN_SAMHEADER__" },
    { "id":"reheader_to_bsortqname", "from": "reheader_headerRGfix", "to": "bamsormadup_qname" },
    { "id":"bsortqname_to_bsortcoordmdup", "from": "bamsormadup_qname", "to": "bamsortcoord_markdup" },
    { "id":"bsortcoordmdup_to_bam_to_cram_output_prep", "from": "bamsortcoord_markdup", "to": "bam_to_cram_output_prep" },
    { "id":"bam_to_cram_output_prep_to_bam_to_cram_seqchksum", "from":"bam_to_cram_output_prep", "to":"bam_to_cram_seqchksum:cram_file" },
    { "id":"src_bam_to_bam_to_cram_seqchksum", "from":"src_bam", "to":"bam_to_cram_seqchksum" }
  ]
}